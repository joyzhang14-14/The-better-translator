===============================================================================
                    DISCORD TRANSLATOR BOT - VERSION CHANGELOG
===============================================================================

Version: 2.2.4
Release Date: 2025-01-20  
Type: Critical Stability & Security Audit Release

===============================================================================
MAJOR FEATURES ADDED IN v2.1.0:
===============================================================================

1. PROMPT DETECTION TOGGLE SYSTEM
   - Added 5th button "术语检测设置 prompt detection settings" to main menu
   - Per-guild control for glossary/prompt detection functionality
   - Two modes available:
     * ENABLED (Default): More accurate translation but slower processing
     * DISABLED: Faster translation but potentially less accurate
   - Persistent configuration stored in config.json under guilds.{guild_id}.glossary_enabled
   - Bilingual interface with Chinese/English support
   - Integration with existing popup cleanup system

2. ENHANCED GLOSSARY PROCESSING CONTROL
   - Smart bypass of glossary processing when disabled for performance
   - Real-time configuration checking in translator.py
   - Proper logging for troubleshooting glossary operations
   - Backward compatibility with existing guilds (default: enabled)

3. USER INTERFACE IMPROVEMENTS
   - Professional button layout with proper styling
   - Clear status indication for current detection mode
   - Comprehensive user guidance on speed vs accuracy trade-offs
   - Seamless integration with existing command structure

===============================================================================
CRITICAL AUDIT FIXES IN v2.2.4:
===============================================================================

1. COMPREHENSIVE ULTRA AUDIT COMPLETION
   - Deep inspection for double preprocessing issues across all code paths
   - Systematic review of main logic for anomalies and edge cases  
   - Implementation of critical security fixes for unsafe configuration access
   - Addition of comprehensive error handling throughout the translation pipeline

2. DOUBLE PREPROCESSING ELIMINATION
   - Fixed star patch processing to use raw_original content instead of preprocessed text
   - Ensured all translation calls preserve emojis by using original content
   - Eliminated emoji loss throughout the translation workflow
   - Unified emoji handling across all processing paths

3. CRITICAL CONFIGURATION SECURITY
   - Replaced all unsafe cfg["key"] access patterns with safe cfg.get("key") calls
   - Added early validation for required configuration fields (channel IDs, webhook URLs)
   - Implemented comprehensive error handling to prevent KeyError crashes
   - Enhanced configuration robustness for production stability

4. TRANSLATION PIPELINE ROBUSTNESS
   - Added try-catch protection around all translation logic to prevent bot crashes
   - Implemented graceful degradation when translation services fail
   - Added error notification system for failed translations
   - Enhanced logging for debugging translation issues

5. STAR PATCH PROCESSING IMPROVEMENTS
   - Fixed unsafe configuration access in star patch edit functionality
   - Enhanced error handling for message history processing
   - Improved logging and debugging capabilities for patch operations
   - Ensured consistent emoji preservation across all patch operations

6. PRODUCTION STABILITY ENHANCEMENTS
   - Eliminated all potential crash points from unsafe configuration access
   - Added comprehensive validation before accessing required configuration
   - Implemented fallback mechanisms for translation failures
   - Enhanced error recovery throughout the bot's operation

===============================================================================
FEATURE ENHANCEMENTS IN v2.2.3:
===============================================================================

1. ADMIN-ONLY BUTTON VISIBILITY SYSTEM
   - Term Detection Settings and Permission Settings buttons now only visible to server owners and whitelisted users
   - Non-admin users only see Report Bug and Glossary buttons
   - Enhanced UI security with dynamic button rendering based on user permissions
   - Improved user experience by hiding irrelevant options from regular users

2. DUAL-CHANNEL TRANSLATION BUG FIX
   - Fixed Chinese channel English input translation: now translates to Chinese (Chinese channel) + sends original English (English channel)
   - Fixed English channel behavior to consistently send both translated and original messages
   - Resolved missing dual-message behavior for English messages from English channel
   - Both channels now have consistent cross-language input handling

===============================================================================
FEATURE ENHANCEMENTS IN v2.2.2:
===============================================================================

1. COMPLETE WHITELIST ROLE MANAGEMENT SYSTEM
   - Added comprehensive role management submenu under Permission Settings
   - Three-tier role management: Add Role, List Roles, Remove Role
   - Modal-based role addition with @role mention or ID support
   - Dropdown-based role removal with name and ID display
   - Real-time role validation and duplicate prevention
   - Professional role management workflow matching user management

2. ENHANCED ROLE ADMINISTRATION
   - Support for Discord role mention format (@&role_id)
   - Intelligent role ID extraction from mentions and direct input
   - Role existence verification before whitelist addition
   - Comprehensive error handling for invalid roles
   - Detailed logging for all role management actions

3. UNIFIED PERMISSION MANAGEMENT INTERFACE
   - Consistent design pattern between user and role management
   - Parallel functionality for both users and roles
   - Professional administrative interface
   - Enhanced navigation and user experience

===============================================================================
FEATURE ENHANCEMENTS IN v2.2.1:
===============================================================================

1. ENHANCED WHITELIST USER MANAGEMENT
   - Added complete user management submenu under Permission Settings
   - Three-tier user management: Add User, List Users, Remove User
   - Modal-based user addition with @mention or ID support
   - Dropdown-based user removal with name and ID display
   - Real-time whitelist validation and duplicate prevention
   - Enhanced error handling and user feedback

2. UI/UX IMPROVEMENTS
   - Changed "术语表 Glossary" button color to purple (blurple) for better visibility
   - Simplified permission setting button labels for cleaner interface
   - Improved menu hierarchy with consistent naming convention
   - Enhanced user experience with streamlined navigation

3. PROFESSIONAL WHITELIST WORKFLOW
   - Industry-standard user management interface
   - Comprehensive user verification and validation
   - Professional error messages and success notifications
   - Detailed logging for administrative actions

===============================================================================
MAJOR FEATURES ADDED IN v2.2.0:
===============================================================================

1. REDESIGNED MAIN MENU INTERFACE
   - Consolidated glossary functions into single "术语表 Glossary" button with submenu
   - Added "权限设置 Permission Settings" button for admin control
   - Streamlined interface from 5 buttons to 4 buttons for better organization
   - Improved user experience with hierarchical menu structure

2. COMPREHENSIVE PERMISSION MANAGEMENT SYSTEM
   - Added permission settings accessible only to server owners and whitelisted users
   - Three-tier permission management: view users, view roles, toggle permission mode
   - Granular control over bot access with whitelist and role-based permissions
   - Real-time permission mode toggling between restricted and open access

3. ENHANCED GLOSSARY MANAGEMENT SUBMENU
   - Dedicated submenu for all term-related operations
   - Add Terms, List Terms, Delete Terms functionality in organized interface
   - Improved workflow for term management with better categorization
   - Professional terminology replacement (prompt → term throughout interface)

4. PROFESSIONAL TERMINOLOGY UPDATES
   - Replaced all instances of "prompt" with "term" for professional consistency
   - Updated button labels, messages, and descriptions to use industry-standard terminology
   - Improved bilingual support with consistent Chinese/English terminology
   - Enhanced professional appearance across all UI elements

===============================================================================
BUG FIXES IN v2.1.6:
===============================================================================

1. PROBLEM REPORT STORAGE FIX
   - Removed cloud storage for problem reports - now only saves to local problem.json
   - Fixed issue where Discord problem reports couldn't be transmitted to local storage
   - Maintained cloud storage only for mirror.json and glossaries.json as intended
   - Simplified problem report workflow with local-only storage

===============================================================================
BUG FIXES IN v2.1.5:
===============================================================================

1. MESSAGE TRACKING ROBUSTNESS
   - Added error handling for ephemeral message tracking with try-catch blocks
   - Fixed potential crashes when tracking popup messages fails
   - Improved stability of message cleanup system across all interaction types
   - Enhanced logging for debugging message tracking issues

===============================================================================
BUG FIXES IN v2.1.4:
===============================================================================

1. RELIABLE MESSAGE CLEANUP SYSTEM
   - Redesigned popup message tracking from list-based to dictionary-based structure
   - Fixed long-term usage issues where message deletion would fail after multiple interactions
   - Improved memory management by tracking only main_message and last_popup per user
   - Enhanced logging for better debugging of message cleanup operations
   - More robust handling of expired or invalid message references

===============================================================================
BUG FIXES IN v2.1.3:
===============================================================================

1. MESSAGE INTERACTION OPTIMIZATION
   - Changed from edit_message to send_message for cleaner UI transitions
   - Bot now sends fresh ephemeral messages instead of editing existing ones
   - Improved user experience with direct popup messages rather than message replies
   - Eliminates visual artifacts from message editing operations

===============================================================================
BUG FIXES IN v2.1.2:
===============================================================================

1. IMMEDIATE BOT MESSAGE CLEANUP
   - Fixed bot message cleanup to delete previous popup messages immediately upon user interaction
   - Changed from bulk deletion to targeted deletion of most recent non-main message
   - Improved user experience with instant UI cleanup when proceeding to next steps
   - Enhanced message tracking to prevent accumulation of undeleted popup messages

===============================================================================
BUG FIXES IN v2.1.1:
===============================================================================

1. CONFIGURATION STATE MANAGEMENT
   - Fixed incorrect status display issue where disabled detection showed as "already enabled"
   - Implemented real-time config reading with _get_current_status() method
   - Removed cached status variables that caused stale state problems
   - Added debug logging for configuration state tracking

2. POPUP MESSAGE CLEANUP
   - Fixed missing cleanup of previous bot messages before showing new dialogs
   - Added _cleanup_old_popups() calls to all button interactions
   - Improved message tracking for proper cleanup sequence
   - Enhanced user experience with cleaner interface transitions

3. UI/UX REFINEMENTS
   - Removed all emojis from bot messages for professional appearance
   - Streamlined message formatting without visual clutter
   - Maintained full bilingual support (Chinese/English)
   - Improved readability of status messages and descriptions

4. TECHNICAL STABILITY
   - Fixed GlossaryToggleView constructor parameter handling
   - Enhanced error handling for config file operations
   - Improved logging for debugging prompt detection issues
   - Ensured proper integration with existing translation pipeline

===============================================================================
PREVIOUS MAJOR CHANGES (Referenced):
===============================================================================

Version 2.0.0 BASELINE FEATURES:
- Traditional Chinese to Simplified Chinese conversion using OpenCC
- Mixed language detection and dual-channel translation
- Glossary system with mandatory and optional replacements
- GPT-based context-aware glossary judgment
- Command popup cleanup system
- Star patch editing functionality
- Multi-channel webhook translation system
- Context-aware translation with message history
- Comprehensive error handling and logging

RECENT INFRASTRUCTURE FIXES:
- Fixed glossary placeholder format to prevent space-to-underscore issues
- Enhanced sentence splitting in translation retry logic
- Improved DeepL integration with proper space preservation
- Centralized preprocessing with traditional Chinese conversion priority

===============================================================================
TECHNICAL SPECIFICATIONS:
===============================================================================

CONFIGURATION STRUCTURE:
{
  "guilds": {
    "guild_id": {
      "glossary_enabled": true,  // Default: enabled
      "zh_channel_id": number,
      "en_channel_id": number,
      "zh_webhook_url": "string",
      "en_webhook_url": "string",
      "admin": { ... }
    }
  }
}

PERFORMANCE IMPACT:
- ENABLED: Full glossary processing + GPT judgment (slower, more accurate)
- DISABLED: Direct translation without glossary checks (faster, potentially less accurate)

COMPATIBILITY:
- Backward compatible with existing guild configurations
- Graceful handling of missing glossary_enabled setting (defaults to true)
- No breaking changes to existing translation workflows

===============================================================================
DEVELOPMENT NOTES:
===============================================================================

VERSION NUMBERING SYSTEM:
- Major.Minor.Patch format (e.g., 2.1.1)
- Minor version (+1) for major feature additions
- Patch version (+1) for bug fixes and small improvements
- Current progression: 2.0.0 → 2.1.0 → 2.1.1 → 2.1.2 → 2.1.3 → 2.1.4 → 2.1.5 → 2.1.6 → 2.2.0 → 2.2.1 → 2.2.2 → 2.2.3 → 2.2.4

CODE QUALITY IMPROVEMENTS:
- Enhanced debug logging throughout glossary system
- Improved error handling for configuration operations
- Better separation of concerns in UI components
- Consistent code documentation and comments

TESTING CONSIDERATIONS:
- Verify prompt detection toggle functionality in multiple guilds
- Test configuration persistence across bot restarts
- Validate popup cleanup behavior with rapid button interactions
- Confirm translation performance differences between enabled/disabled modes

===============================================================================